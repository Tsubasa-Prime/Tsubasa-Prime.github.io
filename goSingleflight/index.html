<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Tsubasa çš„æ—¥è®°</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="ã‚ãŸã—ã€æ°—ã«ãªã‚Šã¾ã™! "/>
<meta name="keywords" content="ã‚ãŸã—ã€æ°—ã«ãªã‚Šã¾ã™! "/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://tsubasa597.github.io/favicon.ico">

<link rel="stylesheet" href="https://tsubasa597.github.io/styles/main.css">

<!-- Modernizr JS -->
<script src="https://tsubasa597.github.io/media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://tsubasa597.github.io/media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://tsubasa597.github.io/images/avatar.png" alt="Tsubasa çš„æ—¥è®°"
                 class="img-responsive">
        </figure>
        <h2>Tsubasa çš„æ—¥è®°</h2>
        <p>ã‚ãŸã—ã€æ°—ã«ãªã‚Šã¾ã™! </p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- æ ‡ç­¾ -->
        <div class="fh5co-box">
            <a href="https://tsubasa597.github.io/tags/"><h3 class="heading">ğŸ‘‰æ ‡ç­¾</h3></a>
            <ul>
                
                    <li><a href="https://tsubasa597.github.io/tag/redis/">Redis</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/go/">Golang</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/designPattern/">è®¾è®¡æ¨¡å¼</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/principlesOfComputer/">è®¡ç®—æœºåŸç†</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/dataStructure/">æ•°æ®ç»“æ„</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/mysql/">MySql</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/git/">Git</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/collections/">é›†åˆ</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/java/">Java</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/algorithm/">ç®—æ³•</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/list/">çº¿æ€§è¡¨</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/vim/">Vim</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/dwm/">Dwm</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/pytorch/">PyTorch</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/deepLearning/">æ·±åº¦å­¦ä¹ </a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/archives"
                        
                        >
                            å½’æ¡£
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            æ ‡ç­¾
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://tsubasa597.github.io">Tsubasa çš„æ—¥è®° </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>ğŸ‘ˆ Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next ğŸ‘‰</span></a>-->

    <!-- ç­‰grideaå‡ºè‡ªå®šä¹‰é¡µé¢åŠŸèƒ½å†ä¼˜åŒ–ä¸€ä¸‹ -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
                    <img src="https://tsubasa597.github.io/post-images/goSingleflight.jpg" alt="Go é˜²æ­¢ç¼“å­˜å‡»ç©¿" class="img-responsive">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
                    <div class="tag-container">
                        
                            <a href="https://tsubasa597.github.io/tag/redis/" class="tag">Redis, </a>
                        
                            <a href="https://tsubasa597.github.io/tag/go/" class="tag">Golang, </a>
                        
                    </div>
                
            </span>
            <h2 class="fh5co-article-title animate-box">Go é˜²æ­¢ç¼“å­˜å‡»ç©¿</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2021-05-31</li>
                <li>837å­—</li>
                <li>4 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <blockquote>
<p>sync.singleflight åŒ…æä¾›äº†ä¸€ç§æŠ‘åˆ¶é‡å¤å‡½æ•°è°ƒç”¨çš„æœºåˆ¶ã€‚</p>
</blockquote>
<h1 id="ç¼“å­˜å‡»ç©¿">ç¼“å­˜å‡»ç©¿</h1>
<p>ç¼“å­˜ åœ¨å„ç§åœºæ™¯ä¸­è¢«å¤§é‡ä½¿ç”¨ï¼Œåœ¨ Cache Missï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šå‡ºç°ä¸‹å›¾çš„æƒ…å†µï¼š<br>
<img src="https://tsubasa597.github.io/post-images/1622457317667.png" alt="" loading="lazy"></p>
<p>æ‰€æœ‰çš„è¯·æ±‚è¢«åŒæ—¶æ‰“åˆ°ä¸‹æ¸¸å­˜å‚¨ä¸Šï¼Œå°†ä¼šå½±å“ä¸‹æ¸¸å­˜å‚¨çš„æœåŠ¡è´¨é‡ï¼Œå› æ­¤éœ€è¦ä¸¥æ ¼é™åˆ¶è®¿é—®ä¸‹æ¸¸å­˜å‚¨çš„å¹¶å‘é‡ã€‚<br>
<img src="https://tsubasa597.github.io/post-images/1622457361413.png" alt="" loading="lazy"></p>
<h1 id="singleflight">singleflight</h1>
<pre><code class="language-go">// Do():  ç›¸åŒçš„ keyï¼Œfn åŒæ—¶åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè¿”å›æ‰§è¡Œçš„ç»“æœç»™fnæ‰§è¡ŒæœŸé—´ï¼Œæ‰€æœ‰ä½¿ç”¨è¯¥ key çš„è°ƒç”¨
// v: fn è¿”å›çš„æ•°æ®
// err: fn è¿”å›çš„err
// shared: è¡¨ç¤ºè¿”å›æ•°æ®æ˜¯è°ƒç”¨ fn å¾—åˆ°çš„è¿˜æ˜¯å…¶ä»–ç›¸åŒ key è°ƒç”¨è¿”å›çš„
func (g *Group) Do(key string, fn func() (interface{}, error)) (v interface{}, err error, shared bool) {
// DoChan(): ç±»ä¼¼Doæ–¹ï¼ˆï¼‰ï¼Œä»¥ chan è¿”å›ç»“æœ
func (g *Group) DoChan(key string, fn func() (interface{}, error)) &lt;-chan Result {
// Forget(): å¤±æ•ˆ keyï¼Œåç»­å¯¹æ­¤ key çš„è°ƒç”¨å°†æ‰§è¡Œ fnï¼Œè€Œä¸æ˜¯ç­‰å¾…å‰é¢çš„è°ƒç”¨å®Œæˆ
func (g *Group) Forget(key string)
</code></pre>
<p>é€šå¸¸ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package main

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;golang.org/x/sync/singleflight&quot;
	&quot;sync/atomic&quot;
	&quot;time&quot;
)

type Result string

func find(ctx context.Context, query string) (Result, error) {
	return Result(fmt.Sprintf(&quot;result for %q&quot;, query)), nil
}

func main() {
	var g singleflight.Group
	const n = 5
	waited := int32(n)
	done := make(chan struct{})
	key := &quot;https://weibo.com/1227368500/H3GIgngon&quot;
	for i := 0; i &lt; n; i++ {
		go func(j int) {
			v, _, shared := g.Do(key, func() (interface{}, error) {
				ret, err := find(context.Background(), key)
				return ret, err
			})
			if atomic.AddInt32(&amp;waited, -1) == 0 {
				close(done)
			}
			fmt.Printf(&quot;index: %d, val: %v, shared: %v\n&quot;, j, v, shared)
		}(i)
	}

	select {
	case &lt;-done:
	case &lt;-time.After(time.Second):
		fmt.Println(&quot;Do hangs&quot;)
	}
}
</code></pre>
<p>å¦‚æœå‡½æ•°æ‰§è¡Œä¸€åˆ‡æ­£å¸¸ï¼Œåˆ™æ‰€æœ‰è¯·æ±‚éƒ½èƒ½é¡ºåˆ©è·å¾—æ­£ç¡®çš„æ•°æ®ã€‚ç›¸åï¼Œå¦‚æœå‡½æ•°æ‰§è¡Œé‡åˆ°é—®é¢˜å‘¢ï¼Ÿç”±äº singleflight æ˜¯ä»¥é˜»å¡è¯»çš„æ–¹å¼æ¥æ§åˆ¶å‘ä¸‹æ¸¸è¯·æ±‚çš„å¹¶å‘é‡ï¼Œåœ¨ç¬¬ä¸€ä¸ªä¸‹æ¸¸è¯·æ±‚æ²¡æœ‰è¿”å›ä¹‹å‰ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å°†è¢«é˜»å¡ã€‚</p>
<h1 id="é—®é¢˜">é—®é¢˜</h1>
<ul>
<li>é˜»å¡è¯»ï¼šç¼ºå°‘è¶…æ—¶æ§åˆ¶ï¼Œéš¾ä»¥å¿«é€Ÿå¤±è´¥</li>
<li>å•å¹¶å‘ï¼šæ§åˆ¶äº†å¹¶å‘é‡ï¼Œä½†ç‰ºç‰²äº†æˆåŠŸç‡</li>
</ul>
<h2 id="é˜»å¡è¯»">é˜»å¡è¯»</h2>
<p>ä½œä¸º Do() çš„æ›¿ä»£å‡½æ•°ï¼Œsingleflight æä¾›äº† DoChan()ã€‚ä¸¤è€…å®ç°ä¸Šå®Œå…¨ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯ï¼ŒDoChan() é€šè¿‡ channel è¿”å›ç»“æœã€‚å› æ­¤å¯ä»¥ä½¿ç”¨ select è¯­å¥å®ç°è¶…æ—¶æ§åˆ¶</p>
<pre><code class="language-go">ch := g.DoChan(key, func() (interface{}, error) {
    ret, err := find(context.Background(), key)
    return ret, err
})
// Create our timeout
timeout := time.After(500 * time.Millisecond)

var ret singleflight.Result
select {
case &lt;-timeout: // Timeout elapsed
        fmt.Println(&quot;Timeout&quot;)
    return
case ret = &lt;-ch: // Received result from channel
    fmt.Printf(&quot;index: %d, val: %v, shared: %v\n&quot;, j, ret.Val, ret.Shared)
}
</code></pre>
<h2 id="å•å¹¶å‘">å•å¹¶å‘</h2>
<p>åœ¨ä¸€äº›å¯¹å¯ç”¨æ€§è¦æ±‚æé«˜çš„åœºæ™¯ä¸‹ï¼Œå¾€å¾€éœ€è¦ä¸€å®šçš„è¯·æ±‚é¥±å’Œåº¦æ¥ä¿è¯ä¸šåŠ¡çš„æœ€ç»ˆæˆåŠŸç‡ã€‚ä¸€æ¬¡è¯·æ±‚è¿˜æ˜¯å¤šæ¬¡è¯·æ±‚ï¼Œå¯¹äºä¸‹æ¸¸æœåŠ¡è€Œè¨€å¹¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œæ­¤æ—¶ä½¿ç”¨ singleflight åªæ˜¯ä¸ºäº†é™ä½è¯·æ±‚çš„æ•°é‡çº§ï¼Œé‚£ä¹ˆä½¿ç”¨ Forget() æé«˜ä¸‹æ¸¸è¯·æ±‚çš„å¹¶å‘:</p>
<pre><code class="language-go">v, _, shared := g.Do(key, func() (interface{}, error) {
    go func() {
        time.Sleep(10 * time.Millisecond)
        fmt.Printf(&quot;Deleting key: %v\n&quot;, key)
        g.Forget(key)
    }()
    ret, err := find(context.Background(), key)
    return ret, err
})
</code></pre>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>å½“ç„¶ï¼Œå¦‚æœå•æ¬¡çš„å¤±è´¥æ— æ³•å®¹å¿ï¼Œåœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹æ›´å¥½çš„å¤„ç†æ–¹æ¡ˆæ˜¯ï¼š</p>
<ul>
<li>æ”¾å¼ƒä½¿ç”¨åŒæ­¥è¯·æ±‚ï¼Œç‰ºç‰²æ•°æ®æ›´æ–°çš„å®æ—¶æ€§</li>
<li>â€œç¼“å­˜â€ å­˜å‚¨å‡†å®æ—¶çš„æ•°æ® + â€œå¼‚æ­¥æ›´æ–°â€ æ•°æ®åˆ°ç¼“å­˜</li>
</ul>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                            <div class="next-post">
                                <div class="next">ä¸‹ä¸€ç¯‡</div>
                                <a href="https://tsubasa597.github.io/goMutex/">
                                    <h3 class="post-title">
                                        Go Mutex
                                    </h3>
                                </a>
                            </div>
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- è¿”å›é¡¶éƒ¨ -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li><a href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF">ç¼“å­˜å‡»ç©¿</a></li>
<li><a href="#singleflight">singleflight</a></li>
<li><a href="#%E9%97%AE%E9%A2%98">é—®é¢˜</a>
<ul>
<li><a href="#%E9%98%BB%E5%A1%9E%E8%AF%BB">é˜»å¡è¯»</a></li>
<li><a href="#%E5%8D%95%E5%B9%B6%E5%8F%91">å•å¹¶å‘</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></p>
</footer>


    <!-- jQuery -->
<script src="https://tsubasa597.github.io/media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://tsubasa597.github.io/media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://tsubasa597.github.io/media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://tsubasa597.github.io/media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://tsubasa597.github.io/media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://tsubasa597.github.io/media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://tsubasa597.github.io/media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->
<script src="https://tsubasa597.github.io/media/scripts/highlight.js"></script>
<!-- <script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script> -->

<script type="application/javascript">
    // ä»£ç é«˜äº®
    hljs.initHighlightingOnLoad();
    
	// img æ‡’åŠ è½½
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // æ‡’åŠ è½½åŠ¨ç”»
            threshold: 180  // åœ¨å›¾ç‰‡è·ç¦»å±å¹•180pxæ—¶æå‰è½½å…¥
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // ç›®å½•
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
        var allImg = $("img");
        allImg.on("contextmenu", function () {
            return false;
        });
        allImg.on("dragstart", function () {
            return false;
        });
    
</script>




</body>
</html>
