<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Tsubasa 的日记</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="わたし、気になります! "/>
<meta name="keywords" content="わたし、気になります! "/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://tsubasa597.github.io/favicon.ico">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/styles/default.min.css">

<link rel="stylesheet" href="https://tsubasa597.github.io/styles/main.css">

<!-- Modernizr JS -->
<script src="https://tsubasa597.github.io/media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://tsubasa597.github.io/media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://tsubasa597.github.io/images/avatar.png" alt="Tsubasa 的日记"
                 class="img-responsive">
        </figure>
        <h2>Tsubasa 的日记</h2>
        <p>わたし、気になります! </p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- 标签 -->
        <div class="fh5co-box">
            <a href="https://tsubasa597.github.io/tags/"><h3 class="heading">👉标签</h3></a>
            <ul>
                
                    <li><a href="https://tsubasa597.github.io/tag/go/">Golang</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/mysql/">MySql</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/java/">Java</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/principlesOfComputer/">计算机原理</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/redis/">Redis</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/designPattern/">设计模式</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/dataStructure/">数据结构</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/git/">Git</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/collections/">集合</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/algorithm/">算法</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/list/">线性表</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/vim/">Vim</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/dwm/">Dwm</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/pytorch/">PyTorch</a></li>
                
                    <li><a href="https://tsubasa597.github.io/tag/deepLearning/">深度学习</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/archives"
                        
                        >
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            标签
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://tsubasa597.github.io">Tsubasa 的日记 </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>👈 Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next 👉</span></a>-->

    <!-- 等gridea出自定义页面功能再优化一下 -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
                    <img src="https://tsubasa597.github.io/post-images/goMutex.jpg" alt="Go Mutex" class="img-responsive">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
                    <div class="tag-container">
                        
                            <a href="https://tsubasa597.github.io/tag/go/" class="tag">Golang, </a>
                        
                    </div>
                
            </span>
            <h2 class="fh5co-article-title animate-box">Go Mutex</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2021-05-31</li>
                <li>1435字</li>
                <li>6 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <blockquote>
<p>互斥锁是并发程序中对共享资源进行访问控制的主要手段，对此Go语言提供了非常简单易用的Mutex，Mutex为一结构体类型，对外暴露两个方法Lock()和Unlock()分别用于加锁和解锁。</p>
</blockquote>
<h1 id="mutex-结构体">Mutex 结构体</h1>
<pre><code class="language-go">type Mutex struct {
	state int32
	sema  uint32
}
</code></pre>
<ul>
<li><code>Mutex.state</code> 表示互斥锁的状态，比如是否被锁定等。</li>
<li><code>Mutex.sema</code> 表示信号量，协程阻塞等待该信号量，解锁的协程释放信号量从而唤醒等待信号量的协程。</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://tsubasa597.github.io/post-images/1622445801855.png" alt="" loading="lazy"></figure>
<ul>
<li><code>Locked</code> : 表示该Mutex是否已被锁定，0：没有锁定 1：已被锁定。</li>
<li><code>Woken</code> : 表示是否有协程已被唤醒，0：没有协程唤醒 1：已有协程唤醒，正在加锁过程中。</li>
<li><code>Starving</code>：表示该Mutex是否处理饥饿状态， 0：没有饥饿 1：饥饿状态，说明有协程阻塞了超过 1 ms。</li>
<li><code>Waiter</code> : 表示阻塞等待锁的协程个数，协程解锁时根据此值来判断是否需要释放信号量。</li>
</ul>
<p>协程之间抢锁实际上是抢给Locked赋值的权利，能给Locked域置1，就说明抢锁成功。抢不到的话就阻塞等待Mutex.sema信号量，一旦持有锁的协程解锁，等待的协程会依次被唤醒。</p>
<h1 id="加解锁过程">加解锁过程</h1>
<h2 id="简单加锁">简单加锁</h2>
<p>假定当前只有一个协程在加锁，没有其他协程干扰，那么过程如下图所示：<br>
<img src="https://tsubasa597.github.io/post-images/1623852740030.png" alt="" loading="lazy"><br>
加锁过程会去判断Locked标志位是否为0，如果是0则把Locked位置1，代表加锁成功。从上图可见，加锁成功后，只是Locked位置1，其他状态位没发生变化。</p>
<h2 id="加锁阻塞">加锁阻塞</h2>
<p>假定加锁时，锁已被其他协程占用了，此时加锁过程如下图所示：<br>
<img src="https://tsubasa597.github.io/post-images/1623852749931.png" alt="" loading="lazy"><br>
从上图可看到，当协程B对一个已被占用的锁再次加锁时，Waiter计数器增加了1，此时协程B将被阻塞，直到Locked值变为0后才会被唤醒。</p>
<h2 id="简单解锁">简单解锁</h2>
<p>假定解锁时，没有其他协程阻塞，此时解锁过程如下图所示：<br>
<img src="https://tsubasa597.github.io/post-images/1622446178328.png" alt="" loading="lazy"><br>
由于没有其他协程阻塞等待加锁，所以此时解锁时只需要把Locked位置为0即可，不需要释放信号量。</p>
<h2 id="解锁并唤醒协程">解锁并唤醒协程</h2>
<p>假定解锁时，有1个或多个协程阻塞，此时解锁过程如下图所示：<br>
<img src="https://tsubasa597.github.io/post-images/1622446197624.png" alt="" loading="lazy"><br>
协程A解锁过程分为两个步骤，一是把Locked位置0，二是查看到Waiter&gt;0，所以释放一个信号量，唤醒一个阻塞的协程，被唤醒的协程B把Locked位置1，于是协程B获得锁。</p>
<h1 id="自旋">自旋</h1>
<p>加锁时，如果当前Locked位为1，说明该锁当前由其他协程持有，尝试加锁的协程并不是马上转入阻塞，而是会持续的探测Locked位是否变为0，这个过程即为自旋过程。</p>
<p>自旋时间很短，但如果在自旋过程中发现锁已被释放，那么协程可以立即获取锁。此时即便有协程被唤醒也无法获取锁，只能再次阻塞。</p>
<h2 id="优势">优势</h2>
<p>自旋更充分的利用了CPU，避免了协程切换。因为当前申请加锁的协程获得了CPU，如果通过短时间自旋就可以获得锁，那么就可以直接运行，而不用阻塞并切换协程。</p>
<h2 id="条件">条件</h2>
<ul>
<li>运行在多 CPU 的机器上</li>
<li>当前 Goroutine 为了获取该锁进入自旋的次数小于四次</li>
<li>当前机器上至少存在一个正在运行的处理器 P 并且处理的运行队列为空</li>
<li>互斥锁只有在普通模式才能进入自旋</li>
</ul>
<pre><code class="language-go">func sync_runtime_canSpin(i int) bool {
	// sync.Mutex is cooperative, so we are conservative with spinning.
	// Spin only few times and only if running on a multicore machine and
	// GOMAXPROCS&gt;1 and there is at least one other running P and local runq is empty.
	// As opposed to runtime mutex we don't do passive spinning here,
	// because there can be work on global runq or on other Ps.
	if i &gt;= active_spin || ncpu &lt;= 1 || gomaxprocs &lt;= int32(sched.npidle+sched.nmspinning)+1 {
		return false
	}
	if p := getg().m.p.ptr(); !runqempty(p) {
		return false
	}
	return true
}
</code></pre>
<h2 id="问题">问题</h2>
<p>如果自旋过程中获得了锁，那么之前阻塞的协程就无法获得锁。如果等待加锁的协程特别多，而都在自旋过程中获得了锁，那么之前阻塞的协程就将一直阻塞。</p>
<p>为了解决这个问题，在1.8的版本之后增加了一个状态 Starving。在这个状态下不会自旋，一定会有一个协程被唤醒并加锁</p>
<h1 id="mutex-模式">Mutex 模式</h1>
<h2 id="normal模式">Normal模式</h2>
<p>默认情况下都是 Normal 模式<br>
当一个协程加锁失败时，不会立即转入等待状态，而是判断是否满足自旋条件，如果满足，则自旋来等待锁</p>
<h2 id="starving模式">Starving模式</h2>
<p>自旋模式抢到锁，表示有协程释放了锁，我们知道释放锁时，如果 waiter &gt; 0，即有阻塞等待的协程，会释放信号量来唤醒协程，当协程被唤醒后，发现 Locked = 1，锁又被抢占，则又会阻塞，但在阻塞前会判断自上次阻塞到本次阻塞经历了多长时间，如果超过 1ms 的话，会将 Mutex 标记为&quot;饥饿&quot;模式，然后再阻塞。<br>
在饥饿模式下，不会启动自旋，如果有协程释放锁，那么一定会唤醒一个协程，被唤醒的协程会获得锁，同时会把 waiter 减 1.</p>
<h2 id="woken状态">Woken状态</h2>
<p>Woken 状态作用于加锁和解锁的过程中，如果一个协程正在解锁，另一个协程在自旋等待加锁，那么会把 Woken 状态置为1，通知解锁的协程不用释放信号量。</p>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                            <div class="next-post">
                                <div class="next">下一篇</div>
                                <a href="https://tsubasa597.github.io/factoryPattern/">
                                    <h3 class="post-title">
                                        工厂模式
                                    </h3>
                                </a>
                            </div>
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- 返回顶部 -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li><a href="#mutex-%E7%BB%93%E6%9E%84%E4%BD%93">Mutex 结构体</a></li>
<li><a href="#%E5%8A%A0%E8%A7%A3%E9%94%81%E8%BF%87%E7%A8%8B">加解锁过程</a>
<ul>
<li><a href="#%E7%AE%80%E5%8D%95%E5%8A%A0%E9%94%81">简单加锁</a></li>
<li><a href="#%E5%8A%A0%E9%94%81%E9%98%BB%E5%A1%9E">加锁阻塞</a></li>
<li><a href="#%E7%AE%80%E5%8D%95%E8%A7%A3%E9%94%81">简单解锁</a></li>
<li><a href="#%E8%A7%A3%E9%94%81%E5%B9%B6%E5%94%A4%E9%86%92%E5%8D%8F%E7%A8%8B">解锁并唤醒协程</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E6%97%8B">自旋</a>
<ul>
<li><a href="#%E4%BC%98%E5%8A%BF">优势</a></li>
<li><a href="#%E6%9D%A1%E4%BB%B6">条件</a></li>
<li><a href="#%E9%97%AE%E9%A2%98">问题</a></li>
</ul>
</li>
<li><a href="#mutex-%E6%A8%A1%E5%BC%8F">Mutex 模式</a>
<ul>
<li><a href="#normal%E6%A8%A1%E5%BC%8F">Normal模式</a></li>
<li><a href="#starving%E6%A8%A1%E5%BC%8F">Starving模式</a></li>
<li><a href="#woken%E7%8A%B6%E6%80%81">Woken状态</a></li>
</ul>
</li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></p>
</footer>


    <!-- jQuery -->
<script src="https://tsubasa597.github.io/media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://tsubasa597.github.io/media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://tsubasa597.github.io/media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://tsubasa597.github.io/media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://tsubasa597.github.io/media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://tsubasa597.github.io/media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://tsubasa597.github.io/media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->

<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/highlight.min.js"></script>
<!-- 
    <script src="https://tsubasa597.github.io/media/scripts/highlight.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script> 
-->

<script type="application/javascript">
    // 代码高亮
    hljs.initHighlightingOnLoad();
    
	// img 懒加载
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // 懒加载动画
            threshold: 180  // 在图片距离屏幕180px时提前载入
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // 目录
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
        var allImg = $("img");
        allImg.on("contextmenu", function () {
            return false;
        });
        allImg.on("dragstart", function () {
            return false;
        });
    
</script>




</body>
</html>
